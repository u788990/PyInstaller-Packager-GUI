name: Build EXE (Cloud Packager v5.0)

on:
  workflow_dispatch:
    inputs:
      source_file:
        description: 'Python main file to package'
        required: true
        default: 'main.py'
        type: string
      
      output_name:
        description: 'Output EXE name (without .exe)'
        required: true
        default: 'MyApp'
        type: string
      
      pack_mode:
        description: 'Packaging mode'
        required: true
        default: 'onefile'
        type: choice
        options:
          - onefile
          - onedir
      
      no_console:
        description: 'Hide console window (for GUI apps)'
        type: boolean
        default: true
      
      python_version:
        description: 'Python version'
        required: false
        default: '3.11'
        type: choice
        options:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'

jobs:
  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python ${{ inputs.python_version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python_version }}
        cache: 'pip'
    
    - name: Upgrade pip
      run: |
        python -m pip install --upgrade pip
        pip --version
      shell: pwsh
    
    - name: Install PyInstaller
      run: |
        pip install pyinstaller
        pyinstaller --version
      shell: pwsh
    
    - name: Install dependencies from requirements.txt
      run: |
        if (Test-Path "requirements.txt") {
          Write-Host "Found requirements.txt, installing dependencies..."
          pip install -r requirements.txt
        } else {
          Write-Host "No requirements.txt found, skipping..."
        }
      shell: pwsh
    
    - name: Display installed packages
      run: pip list
      shell: pwsh
    
    - name: Build EXE with Cloud Packager
      run: |
        $noconsole = ""
        if ("${{ inputs.no_console }}" -eq "true") {
          $noconsole = "--noconsole"
        }
        
        Write-Host "Building with parameters:"
        Write-Host "  Source: ${{ inputs.source_file }}"
        Write-Host "  Name: ${{ inputs.output_name }}"
        Write-Host "  Mode: ${{ inputs.pack_mode }}"
        Write-Host "  No Console: ${{ inputs.no_console }}"
        
        python main.py --cloud `
          --source "${{ inputs.source_file }}" `
          --name "${{ inputs.output_name }}" `
          --mode "${{ inputs.pack_mode }}" `
          $noconsole
      shell: pwsh
    
    - name: Check build result
      run: |
        $mode = "${{ inputs.pack_mode }}"
        $name = "${{ inputs.output_name }}"
        
        if ($mode -eq "onefile") {
          $exePath = "dist\$name.exe"
        } else {
          $exePath = "dist\$name\$name.exe"
        }
        
        if (Test-Path $exePath) {
          $fileSize = (Get-Item $exePath).Length / 1MB
          Write-Host "SUCCESS: Build completed!"
          Write-Host "EXE Path: $exePath"
          Write-Host "EXE Size: $([math]::Round($fileSize, 2)) MB"
        } else {
          Write-Host "ERROR: Expected output not found: $exePath"
          Get-ChildItem -Path "dist" -Recurse -ErrorAction SilentlyContinue | Format-Table Name, Length
          exit 1
        }
      shell: pwsh
    
    - name: Upload artifact (onefile mode)
      if: inputs.pack_mode == 'onefile'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.output_name }}-windows-exe
        path: dist/${{ inputs.output_name }}.exe
        retention-days: 7
        if-no-files-found: error
    
    - name: Upload artifact (onedir mode)
      if: inputs.pack_mode == 'onedir'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.output_name }}-windows-dist
        path: dist/${{ inputs.output_name }}/
        retention-days: 7
        if-no-files-found: error

  # 可选: 跨平台构建
  build-linux:
    name: Build Linux Binary
    runs-on: ubuntu-latest
    if: false  # 默认禁用，需要时改为 true
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python_version || '3.11' }}
    
    - name: Install dependencies
      run: |
        pip install pyinstaller
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Build
      run: |
        python main.py --cloud \
          --source "${{ inputs.source_file }}" \
          --name "${{ inputs.output_name }}" \
          --mode "${{ inputs.pack_mode }}" \
          ${{ inputs.no_console == 'true' && '--noconsole' || '' }}
    
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.output_name }}-linux
        path: dist/
